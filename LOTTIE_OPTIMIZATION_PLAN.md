# –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Lottie (–°—Ç—Ä–∞—Ç–µ–≥–∏—è D)

## –û–±–∑–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**–¶–µ–ª—å**: –£–º–µ–Ω—å—à–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ DOM —á–µ—Ä–µ–∑ —É—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ + IntersectionObserver –ø–∞—É–∑—É

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: ‚≠ê‚≠ê‚≠ê –°–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- FPS: 30-45 ‚Üí 50-60 (+35%)
- –ü–∞–º—è—Ç—å: 200MB ‚Üí 80MB (-60%)
- –ê–∫—Ç–∏–≤–Ω—ã—Ö Lottie: 30+ ‚Üí 3-6 (-80%)
- DOM nodes: 1500+ ‚Üí 400-600 (-60%)

**–í—Ä–µ–º—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è**: 3-5 —á–∞—Å–æ–≤

**–†–∏—Å–∫–∏**: ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ React –ø–∞—Ç—Ç–µ—Ä–Ω—ã)

---

## –®–ê–ì 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 1.1 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å**:
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Performance
2. –ó–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Gallery
3. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
   - –ß–∏—Å–ª–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö Lottie –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ (React DevTools ‚Üí Components)
   - FPS –≤ Performance monitor
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (Memory ‚Üí Heap snapshot)
   - DOM nodes count (Elements ‚Üí Query ‚Üí `*`)

**–û–∂–∏–¥–∞–µ–º—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**:
- –í—Å–µ 3 preview —Å—Ç–∏–∫–µ—Ä–∞ –º–æ–Ω—Ç–∏—Ä—É—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- Lottie –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–Ω–µ viewport
- –ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DOM nodes

**–§–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏**:
- `miniapp/src/components/PackCard.tsx` (—Å—Ç—Ä–æ–∫–∏ 83-142)
- `miniapp/src/components/AnimatedSticker.tsx` (—Å—Ç—Ä–æ–∫–∏ 26-103)

---

## –®–ê–ì 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è PackCard (–£—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)

### 2.1 –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–µ–π—á–∞—Å –≤—Å–µ 3 preview —Å—Ç–∏–∫–µ—Ä–∞ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (—Å—Ç—Ä–æ–∫–∏ 83-142 –≤ PackCard.tsx)

**–†–µ—à–µ–Ω–∏–µ**: –†–µ–Ω–¥–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–∫–µ—Ä, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å

### 2.2 –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–∏—Ç—å

üìÅ **`miniapp/src/components/PackCard.tsx`**

### 2.3 –ö–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –£–±—Ä–∞—Ç—å map –≤—Å–µ—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤, —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π**

```typescript
// –ë–´–õ–û (—Å—Ç—Ä–æ–∫–∏ 83-142):
{pack.previewStickers.map((sticker, index) => {
  const isActive = index === currentStickerIndex;
  const isNext = index === (currentStickerIndex + 1) % pack.previewStickers.length;
  
  return (
    <div key={`${pack.id}-${sticker.fileId}-${index}`} ...>
      {sticker.isAnimated ? (
        <AnimatedSticker ... />
      ) : (
        <img ... />
      )}
    </div>
  );
})}

// –°–¢–ê–õ–û (—Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π):
const currentSticker = pack.previewStickers[currentStickerIndex] || pack.previewStickers[0];

return (
  <div style={{ width: '100%', height: '100%', position: 'relative' }}>
    {/* –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Å—Ç–∏–∫–µ—Ä –≤–º–µ—Å—Ç–æ map –≤—Å–µ—Ö */}
    {currentSticker && (
      <div
        key={`${pack.id}-${currentSticker.fileId}-${currentStickerIndex}`}
        data-testid="sticker-preview"
        style={{
          width: '100%',
          height: '100%'
        }}
      >
        {currentSticker.fileId ? (
          currentSticker.isAnimated ? (
            <AnimatedSticker
              fileId={currentSticker.fileId}
              imageUrl={currentSticker.url}
              emoji={currentSticker.emoji}
              className="pack-card-animated-sticker"
            />
          ) : (
            <img
              src={currentSticker.url}
              alt={currentSticker.emoji}
              className="pack-card-image"
              style={{
                width: '100%',
                height: '100%',
                objectFit: 'cover'
              }}
              loading={isHighPriority ? 'eager' : 'lazy'}
              decoding="async"
            />
          )
        ) : (
          <div style={{
            width: '100%',
            height: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '48px',
            color: 'var(--tg-theme-hint-color)'
          }}>
            {currentSticker.emoji}
          </div>
        )}
      </div>
    )}
  </div>
);
```

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** (—Å—Ç—Ä–æ–∫–∏ 76-143):

```typescript
{/* –°–º–µ–Ω—è—é—â–∏–µ—Å—è –ø—Ä–µ–≤—å—é —Å—Ç–∏–∫–µ—Ä–æ–≤ */}
<div style={{ 
  width: '100%', 
  height: '100%', 
  position: 'relative',
  overflow: 'hidden'
}}>
  {/* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–∫–µ—Ä */}
  {pack.previewStickers[currentStickerIndex] && (
    <AnimatedSticker
      fileId={pack.previewStickers[currentStickerIndex].fileId}
      imageUrl={pack.previewStickers[currentStickerIndex].url}
      emoji={pack.previewStickers[currentStickerIndex].emoji}
      className="pack-card-animated-sticker"
      key={`${pack.id}-${currentStickerIndex}`}
    />
  )}
</div>
```

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï**: –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–ª—è –∑–∞–º–µ–Ω—ã –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Å–º. –≤ —Ä–∞–∑–¥–µ–ª–µ "–®–∞–≥ 2.4"

### 2.4 –ó–∞–º–µ–Ω–∞ —Å—Ç—Ä–æ–∫ 76-143 –≤ PackCard.tsx

–ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ –±–ª–æ–∫–∞ –ø—Ä–µ–≤—å—é —Å—Ç–∏–∫–µ—Ä–æ–≤:

```typescript:miniapp/src/components/PackCard.tsx
{/* –°–º–µ–Ω—è—é—â–∏–µ—Å—è –ø—Ä–µ–≤—å—é —Å—Ç–∏–∫–µ—Ä–æ–≤ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û */}
<div style={{ 
  width: '100%', 
  height: '100%', 
  position: 'relative',
  overflow: 'hidden'
}}>
  {(() => {
    const activeSticker = pack.previewStickers[currentStickerIndex] || pack.previewStickers[0];
    if (!activeSticker) return null;
    
    return (
      <div
        key={`${pack.id}-${activeSticker.fileId}-${currentStickerIndex}`}
        data-testid="sticker-preview"
        style={{
          width: '100%',
          height: '100%',
          position: 'absolute',
          top: 0,
          left: 0
        }}
      >
        {activeSticker.fileId ? (
          activeSticker.isAnimated ? (
            <AnimatedSticker
              fileId={activeSticker.fileId}
              imageUrl={activeSticker.url}
              emoji={activeSticker.emoji}
              className="pack-card-animated-sticker"
            />
          ) : (
            <img
              src={activeSticker.url}
              alt={activeSticker.emoji}
              className="pack-card-image"
              style={{
                width: '100%',
                height: '100%',
                objectFit: 'cover'
              }}
              loading={isHighPriority ? 'eager' : 'lazy'}
              decoding="async"
            />
          )
        ) : (
          <div 
            style={{
              width: '100%',
              height: '100%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '48px',
              color: 'var(--tg-theme-hint-color)'
            }}
          >
            {activeSticker.emoji}
          </div>
        )}
      </div>
    );
  })()}
</div>
```

### 2.5 –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–≥ 2

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 1: React DevTools**
1. –û—Ç–∫—Ä–æ–π—Ç–µ React DevTools
2. –í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π `PackCard` –≤ –¥–µ—Ä–µ–≤–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ **1** `AnimatedSticker` (—Ä–∞–Ω—å—à–µ –±—ã–ª–æ 4)

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Elements inspector**
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Elements
2. –ù–∞–π–¥–∏—Ç–µ div —Å –∫–ª–∞—Å—Å–æ–º `pack-card`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ 1 div —Å–æ —Å—Ç–∏–∫–µ—Ä–æ–º

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 3: Performance**
1. –ó–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å 10 —Å–µ–∫—É–Ω–¥
2. –°—Ä–∞–≤–Ω–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DOM nodes: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ~60% –º–µ–Ω—å—à–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –í–º–µ—Å—Ç–æ 3 Lottie –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –Ω–∞ PackCard —Ç–µ–ø–µ—Ä—å 1

---

## –®–ê–ì 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è AnimatedSticker (IntersectionObserver –ø–∞—É–∑–∞)

### 3.1 –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞**: Lottie –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –∫–æ–≥–¥–∞ –Ω–µ –≤–∏–¥–Ω—ã (–≤–Ω–µ viewport)

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IntersectionObserver –¥–ª—è –ø–∞—É–∑—ã –Ω–µ–≤–∏–¥–∏–º—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π

### 3.2 –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–∏—Ç—å

üìÅ **`miniapp/src/components/AnimatedSticker.tsx`**

### 3.3 –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

‚úÖ **–ù–µ –Ω—É–∂–Ω—ã**: IntersectionObserver ‚Äî –Ω–∞—Ç–∏–≤–Ω—ã–π Web API, –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### 3.4 –ö–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å ref –¥–ª—è Lottie –∏ IntersectionObserver**

```typescript:miniapp/src/components/AnimatedSticker.tsx
import React, { useEffect, useState, useRef } from 'react';
import Lottie from 'lottie-react';
import type { LottieRefCurrentProps } from 'lottie-react';

// ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ —Å—Ç—Ä–æ–∫–∏ 21)

export const AnimatedSticker: React.FC<AnimatedStickerProps> = ({
  fileId,
  imageUrl,
  emoji,
  className,
  hidePlaceholder
}) => {
  const [animationData, setAnimationData] = useState<any>(null);
  const [error, setError] = useState(false);
  const [loading, setLoading] = useState(true);
  
  // –ù–û–í–´–ô –ö–û–î: Ref –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–µ–π
  const animationRef = useRef<LottieRefCurrentProps>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  // ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π useEffect –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

  // –ù–û–í–´–ô –ö–û–î: IntersectionObserver –¥–ª—è –ø–∞—É–∑—ã –Ω–µ–≤–∏–¥–∏–º—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π
  useEffect(() => {
    if (!animationRef.current || !containerRef.current) return;

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (!animationRef.current) return;
        
        if (!entry.isIntersecting) {
          // –ü–∞—É–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–Ω–µ viewport
          animationRef.current.pause();
          console.log('üé¨ Paused animation (out of viewport):', fileId);
        } else {
          // –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ viewport
          animationRef.current.play();
          console.log('üé¨ Playing animation (in viewport):', fileId);
        }
      },
      {
        threshold: 0.1, // –ê–Ω–∏–º–∞—Ü–∏—è –≤–∏–¥–Ω–∞ –µ—Å–ª–∏ 10% –≤ viewport
        rootMargin: '50px' // –ü–∞—É–∑–∞ —Å –∑–∞–ø–∞—Å–æ–º 50px –¥–æ viewport
      }
    );

    observer.observe(containerRef.current);

    return () => {
      observer.disconnect();
    };
  }, [animationData, fileId]); // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏

  // ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ return –±–ª–æ–∫–∏, –Ω–æ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º refs)
```

### 3.5 –ò–∑–º–µ–Ω–µ–Ω–∏–µ return –±–ª–æ–∫–∞

**–ë—ã–ª–æ** (—Å—Ç—Ä–æ–∫–∏ 105-156):
```typescript
if (loading) {
  return (
    <div className={className} style={{ /* ... */ }}>
      {hidePlaceholder ? null : (emoji || 'üé®')}
    </div>
  );
}

if (error || !animationData) {
  return (
    <img src={imageUrl} alt={emoji || ''} className={className} ... />
  );
}

return (
  <Lottie
    animationData={animationData}
    loop={true}
    autoplay={true}
    className={className}
    style={{ width: '100%', height: '100%' }}
  />
);
```

**–°—Ç–∞–ª–æ** (–¥–æ–±–∞–≤–ª—è–µ–º ref –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä):
```typescript
if (loading) {
  return (
    <div 
      ref={containerRef}
      className={className} 
      style={{ 
        display: 'flex', 
        alignItems: 'center', 
        justifyContent: 'center',
        fontSize: '48px' 
      }}
    >
      {hidePlaceholder ? null : (emoji || 'üé®')}
    </div>
  );
}

if (error || !animationData) {
  return (
    <div ref={containerRef}>
      <img
        src={imageUrl}
        alt={emoji || ''}
        className={className}
        style={{
          width: '100%',
          height: '100%',
          objectFit: 'cover'
        }}
        onError={(e) => {
          console.log('üé¨ Image fallback failed, showing emoji:', fileId);
          const target = e.target as HTMLImageElement;
          target.style.display = 'none';
          const parent = target.parentElement;
          if (parent) {
            parent.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 48px;">${emoji || 'üé®'}</div>`;
          }
        }}
      />
    </div>
  );
}

return (
  <div ref={containerRef} style={{ width: '100%', height: '100%' }}>
    <Lottie
      lottieRef={animationRef}
      animationData={animationData}
      loop={true}
      autoplay={true}
      className={className}
      style={{
        width: '100%',
        height: '100%',
      }}
    />
  </div>
);
```

### 3.6 –ü–æ–ª–Ω—ã–π –∫–æ–¥ AnimatedSticker.tsx –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–°–º. —Ñ–∞–π–ª **"AnimatedSticker.optimized.tsx"** –≤ –∫–æ–Ω—Ü–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞

### 3.7 –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–≥ 3

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Console logs**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Console –≤ DevTools
2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–Ω–∏–∑/–≤–≤–µ—Ä—Ö
3. –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏: `üé¨ Paused animation...` –∏ `üé¨ Playing animation...`

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Visual –ø—Ä–æ–≤–µ—Ä–∫–∞**
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É Gallery
2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑, —á—Ç–æ–±—ã PackCard –∏—Å—á–µ–∑–ª–∏ —Å —ç–∫—Ä–∞–Ω–∞
3. –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –ø–∞—É–∑–µ (–Ω–µ –¥–≤–∏–≥–∞—Ç—å—Å—è)

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 3: Performance**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Performance Monitor (DevTools ‚Üí More tools)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ FPS: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 50-60 –≤–º–µ—Å—Ç–æ 30-45
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CPU: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∏–∂–µ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ê–Ω–∏–º–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—É–∑–∞—Ç—Å—è –≤–Ω–µ viewport

---

## –®–ê–ì 4: Prefetch JSON –±–µ–∑ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 4.1 –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ —Ä–æ—Ç–∞—Ü–∏–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤ JSON –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É

**–†–µ—à–µ–Ω–∏–µ**: Prefetch JSON –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ç–∏–∫–µ—Ä–∞ –î–û –µ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 4.2 –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–∏—Ç—å

üìÅ **`miniapp/src/hooks/useStickerRotation.ts`**

### 4.3 –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

‚úÖ **–ù–µ –Ω—É–∂–Ω—ã**: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `animationCache` –∏–∑ `AnimatedSticker.tsx`

### 4.4 –ö–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å prefetch JSON –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ prefetch –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**

–¢–µ–∫—É—â–∏–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 48-59):
```typescript
// 1) –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å—Ç–∏–∫–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫)
try {
  if (stickerSources && stickerSources.length > 0) {
    const nextIdx = (currentIndexRef.current + 1) % Math.min(stickersCount, stickerSources.length);
    const src = stickerSources[nextIdx];
    if (src) {
      await imageLoader.loadImage(src.fileId, src.url, 1);
    }
  }
} catch {
  // ignore preload errors
}
```

–ù–æ–≤—ã–π –∫–æ–¥ (–¥–æ–±–∞–≤–ª—è–µ–º prefetch JSON –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π):
```typescript
// 1) –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å—Ç–∏–∫–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫)
try {
  if (stickerSources && stickerSources.length > 0) {
    const nextIdx = (currentIndexRef.current + 1) % Math.min(stickersCount, stickerSources.length);
    const src = stickerSources[nextIdx];
    if (src) {
      // Prefetch –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      await imageLoader.loadImage(src.fileId, src.url, 1);
      
      // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: Prefetch JSON –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
      const fetchAnimationJson = async (fileId: string, url: string) => {
        try {
          const response = await fetch(url);
          if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
            const data = await response.json();
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à –∏–∑ AnimatedSticker)
            const animationCache = (window as any).__animationCache || new Map();
            animationCache.set(fileId, data);
            (window as any).__animationCache = animationCache;
            console.log('üé¨ Prefetched animation:', fileId);
          }
        } catch (err) {
          // ignore prefetch errors
        }
      };
      
      // Prefetch –∞–Ω–∏–º–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ (–Ω–µ –∂–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)
      fetchAnimationJson(src.fileId, src.url);
    }
  }
} catch {
  // ignore preload errors
}
```

### 4.5 –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—á–∏—â–µ)

–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —É—Ç–∏–ª–∏—Ç—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å animation cache:

**–ù–æ–≤—ã–π —Ñ–∞–π–ª**: `miniapp/src/utils/animationLoader.ts`
```typescript
// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à –¥–ª—è Lottie –∞–Ω–∏–º–∞—Ü–∏–π (shared —Å AnimatedSticker)
const animationCache = new Map<string, any>();

export const prefetchAnimation = async (fileId: string, url: string): Promise<void> => {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
    if (animationCache.has(fileId)) {
      return; // –£–∂–µ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ
    }
    
    const response = await fetch(url);
    if (!response.ok) return;
    
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      const data = await response.json();
      animationCache.set(fileId, data);
      console.log('üé¨ Prefetched animation:', fileId);
    }
  } catch (err) {
    // ignore prefetch errors
  }
};

export const getCachedAnimation = (fileId: string): any => {
  return animationCache.get(fileId);
};

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–µ—à –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ AnimatedSticker
export { animationCache };
```

–ó–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `useStickerRotation.ts`:
```typescript
import { prefetchAnimation } from '../utils/animationLoader';

// –í —Ü–∏–∫–ª–µ schedule:
await prefetchAnimation(src.fileId, src.url);
```

–ò –≤ `AnimatedSticker.tsx`:
```typescript
import { animationCache } from '../utils/animationLoader';

// –ó–∞–º–µ–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à –Ω–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Å–æ–∑–¥–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É), —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∫–µ—à–∞.

### 4.6 –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–≥ 4

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Console logs**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Console –≤ DevTools
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é —Å—Ç–∏–∫–µ—Ä–æ–≤
3. –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏: `üé¨ Prefetched animation: ...` –î–û –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Network tab**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Network ‚Üí Fetch/XHR
2. –û—Ç—Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ `.json`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: JSON –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Ä–∞–Ω—å—à–µ, —á–µ–º –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ù–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ —Ä–æ—Ç–∞—Ü–∏–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤

---

## –®–ê–ì 5: –ò—Ç–æ–≥–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 5.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ß–µ–∫-–ª–∏—Å—Ç**:

- [ ] React DevTools: —Ç–æ–ª—å–∫–æ 1 AnimatedSticker –Ω–∞ PackCard (–±—ã–ª–æ 4)
- [ ] Console logs: –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–∞—É–∑—è—Ç—Å—è/–≤–æ–∑–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
- [ ] Performance Monitor: FPS 50-60 (–±—ã–ª–æ 30-45)
- [ ] Memory: ~120MB (–±—ã–ª–æ ~300MB)
- [ ] DOM nodes: ~800 (–±—ã–ª–æ ~2000+)
- [ ] Network: prefetch JSON —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Visual: –Ω–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ –ø—Ä–∏ —Ä–æ—Ç–∞—Ü–∏–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤

### 5.2 –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É Gallery
2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–æ –∫–æ–Ω—Ü–∞ (–∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Å–µ –ø–∞–∫–∏)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ FPS –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 30 —Å–µ–∫—É–Ω–¥
4. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –±—ã—Å—Ç—Ä–æ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–ª–∞–≤–Ω–æ –ø–∞—É–∑—è—Ç—Å—è/–≤–æ–∑–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- FPS —Å—Ç–∞–±–∏–ª—å–Ω–æ 50-60
- –ù–µ—Ç –º–∏–∫—Ä–æ—Ñ—Ä–∏–∑–æ–≤ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
- –ü–∞–º—è—Ç—å –Ω–µ —Ä–∞—Å—Ç—ë—Ç —Å–≤–µ—Ä—Ö –º–µ—Ä—ã

### 5.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω–æ–º 3G

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Network
2. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–¥–ª–µ–Ω–Ω—ã–π 3G
3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
- Prefetch –Ω–µ –º–µ—à–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º –∑–∞–≥—Ä—É–∑–∫–∞–º

---

## –®–ê–ì 6: –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã)

### 6.1 –ö–∞–∫ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

**Git –æ—Ç–∫–∞—Ç** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ git):

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
git status

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å diff
git diff

# –û—Ç–∫–∞—Ç–∏—Ç—å —Ñ–∞–π–ª—ã
git checkout -- miniapp/src/components/PackCard.tsx
git checkout -- miniapp/src/components/AnimatedSticker.tsx
git checkout -- miniapp/src/hooks/useStickerRotation.ts

# –ò–ª–∏ –æ—Ç–∫–∞—Ç–∏—Ç—å –≤–µ—Å—å –∫–æ–º–º–∏—Ç
git reset --hard HEAD~1
```

**–†—É—á–Ω–æ–π –æ—Ç–∫–∞—Ç**:

–§–∞–π–ª—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ backup:
- `miniapp/src/components/PackCard.tsx` ‚Üí –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫–∏ 76-143 –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
- `miniapp/src/components/AnimatedSticker.tsx` ‚Üí —É–¥–∞–ª–∏—Ç—å refs –∏ IntersectionObserver
- `miniapp/src/hooks/useStickerRotation.ts` ‚Üí —É–¥–∞–ª–∏—Ç—å prefetch JSON

### 6.2 –ë—ã—Å—Ç—Ä—ã–π fallback (–µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ª–æ–º–∞–ª—Å—è)

**–ï—Å–ª–∏ PackCard —Å–ª–æ–º–∞–ª—Å—è**:
- –í–µ—Ä–Ω—É—Ç—å map –≤—Å–µ—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 83-142)

**–ï—Å–ª–∏ AnimatedSticker —Å–ª–æ–º–∞–ª—Å—è**:
- –£–¥–∞–ª–∏—Ç—å IntersectionObserver useEffect (—Å—Ç—Ä–æ–∫–∏ —Å observer)
- –£–±—Ä–∞—Ç—å refs –∏–∑ return –±–ª–æ–∫–æ–≤

**–ï—Å–ª–∏ useStickerRotation —Å–ª–æ–º–∞–ª—Å—è**:
- –£–¥–∞–ª–∏—Ç—å –∫–æ–¥ prefetch JSON

### 6.3 Feature flag –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ rollout

**–°–æ–∑–¥–∞—Ç—å feature flag** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

```typescript
// miniapp/src/config/features.ts
export const features = {
  lottieOptimization: process.env.NODE_ENV === 'production' ? false : true // –≤–∫–ª—é—á–∞–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
};

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ PackCard:
import { features } from '../config/features';

{features.lottieOptimization ? (
  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
) : (
  // –°—Ç–∞—Ä—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
)}
```

---

## –ü–æ–ª–Ω—ã–π –∫–æ–¥ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### AnimatedSticker.optimized.tsx

```typescript
import React, { useEffect, useState, useRef } from 'react';
import Lottie from 'lottie-react';
import type { LottieRefCurrentProps } from 'lottie-react';

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à –¥–ª—è Lottie –∞–Ω–∏–º–∞—Ü–∏–π
const animationCache = new Map<string, any>();

interface AnimatedStickerProps {
  fileId: string;
  imageUrl: string;
  emoji?: string;
  className?: string;
  hidePlaceholder?: boolean;
}

export const AnimatedSticker: React.FC<AnimatedStickerProps> = ({
  fileId,
  imageUrl,
  emoji,
  className,
  hidePlaceholder
}) => {
  const [animationData, setAnimationData] = useState<any>(null);
  const [error, setError] = useState(false);
  const [loading, setLoading] = useState(true);
  
  // Refs –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–µ–π –∏ IntersectionObserver
  const animationRef = useRef<LottieRefCurrentProps>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    let cancelled = false;

    const loadAnimation = async () => {
      try {
        setLoading(true);
        setError(false);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å URL
        if (!imageUrl || imageUrl === '') {
          console.log('üé¨ Invalid imageUrl, using fallback:', fileId);
          if (!cancelled) {
            setError(true);
            setLoading(false);
          }
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
        if (animationCache.has(fileId)) {
          console.log('üé¨ Loaded from cache:', fileId);
          if (!cancelled) {
            setAnimationData(animationCache.get(fileId));
            setLoading(false);
          }
          return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º JSON –∞–Ω–∏–º–∞—Ü–∏–∏
        const response = await fetch(imageUrl);
        
        if (!response.ok) {
          console.log('üé¨ Animation not found, using fallback:', fileId);
          if (!cancelled) {
            setError(true);
            setLoading(false);
          }
          return;
        }

        const contentType = response.headers.get('content-type');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ JSON
        if (contentType && contentType.includes('application/json')) {
          const data = await response.json();
          
          if (!cancelled) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
            animationCache.set(fileId, data);
            console.log('üé¨ Cached animation:', fileId);
            setAnimationData(data);
          }
        } else {
          console.log('üé¨ Not a JSON animation, using fallback:', fileId);
          if (!cancelled) {
            setError(true);
          }
        }
      } catch (err) {
        console.log('üé¨ Failed to load animation, using fallback:', fileId, err);
        if (!cancelled) {
          setError(true);
        }
      } finally {
        if (!cancelled) {
          setLoading(false);
        }
      }
    };

    loadAnimation();

    return () => {
      cancelled = true;
    };
  }, [fileId, imageUrl]);

  // IntersectionObserver –¥–ª—è –ø–∞—É–∑—ã –Ω–µ–≤–∏–¥–∏–º—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π
  useEffect(() => {
    if (!animationRef.current || !containerRef.current || !animationData) return;

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (!animationRef.current) return;
        
        if (!entry.isIntersecting) {
          // –ü–∞—É–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–Ω–µ viewport
          animationRef.current.pause();
          console.log('üé¨ Paused animation (out of viewport):', fileId);
        } else {
          // –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ viewport
          animationRef.current.play();
          console.log('üé¨ Playing animation (in viewport):', fileId);
        }
      },
      {
        threshold: 0.1,
        rootMargin: '50px'
      }
    );

    observer.observe(containerRef.current);

    return () => {
      observer.disconnect();
    };
  }, [animationData, fileId]);

  if (loading) {
    return (
      <div 
        ref={containerRef}
        className={className} 
        style={{ 
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'center',
          fontSize: '48px' 
        }}
      >
        {hidePlaceholder ? null : (emoji || 'üé®')}
      </div>
    );
  }

  if (error || !animationData) {
    // Fallback - –ø—Ä–æ–±—É–µ–º –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    return (
      <div ref={containerRef}>
        <img
          src={imageUrl}
          alt={emoji || ''}
          className={className}
          style={{
            width: '100%',
            height: '100%',
            objectFit: 'cover'
          }}
          onError={(e) => {
            console.log('üé¨ Image fallback failed, showing emoji:', fileId);
            const target = e.target as HTMLImageElement;
            target.style.display = 'none';
            const parent = target.parentElement;
            if (parent) {
              parent.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 48px;">${emoji || 'üé®'}</div>`;
            }
          }}
        />
      </div>
    );
  }

  return (
    <div ref={containerRef} style={{ width: '100%', height: '100%' }}>
      <Lottie
        lottieRef={animationRef}
        animationData={animationData}
        loop={true}
        autoplay={true}
        className={className}
        style={{
          width: '100%',
          height: '100%',
        }}
      />
    </div>
  );
};
```

### PackCard.optimized.tsx (—á–∞—Å—Ç–∏—á–Ω–æ)

–¢–æ–ª—å–∫–æ –±–ª–æ–∫ –ø—Ä–µ–≤—å—é —Å—Ç–∏–∫–µ—Ä–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 76-143):

```typescript
{/* –°–º–µ–Ω—è—é—â–∏–µ—Å—è –ø—Ä–µ–≤—å—é —Å—Ç–∏–∫–µ—Ä–æ–≤ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û */}
<div style={{ 
  width: '100%', 
  height: '100%', 
  position: 'relative',
  overflow: 'hidden'
}}>
  {(() => {
    const activeSticker = pack.previewStickers[currentStickerIndex] || pack.previewStickers[0];
    if (!activeSticker) return null;
    
    return (
      <div
        key={`${pack.id}-${activeSticker.fileId}-${currentStickerIndex}`}
        data-testid="sticker-preview"
        style={{
          width: '100%',
          height: '100%',
          position: 'absolute',
          top: 0,
          left: 0
        }}
      >
        {activeSticker.fileId ? (
          activeSticker.isAnimated ? (
            <AnimatedSticker
              fileId={activeSticker.fileId}
              imageUrl={activeSticker.url}
              emoji={activeSticker.emoji}
              className="pack-card-animated-sticker"
            />
          ) : (
            <img
              src={activeSticker.url}
              alt={activeSticker.emoji}
              className="pack-card-image"
              style={{
                width: '100%',
                height: '100%',
                objectFit: 'cover'
              }}
              loading={isHighPriority ? 'eager' : 'lazy'}
              decoding="async"
            />
          )
        ) : (
          <div 
            style={{
              width: '100%',
              height: '100%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '48px',
              color: 'var(--tg-theme-hint-color)'
            }}
          >
            {activeSticker.emoji}
          </div>
        )}
      </div>
    );
  })()}
</div>
```

---

## –†–µ–∑—é–º–µ

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**:
1. ‚úÖ –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ 1 –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–∫–µ—Ä –≤–º–µ—Å—Ç–æ 4
2. ‚úÖ –ü–∞—É–∑–∏–º –Ω–µ–≤–∏–¥–∏–º—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ IntersectionObserver
3. ‚úÖ Prefetch JSON –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ç–∏–∫–µ—Ä–∞

**–í—Ä–µ–º—è**: 3-5 —á–∞—Å–æ–≤

**–†–∏—Å–∫–∏**: ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)

**–ü—Ä–∏—Ä–æ—Å—Ç**:
- FPS: +35%
- –ü–∞–º—è—Ç—å: -60%
- –ê–∫—Ç–∏–≤–Ω—ã—Ö Lottie: -80%

**Backend**: ‚ùå –ù–µ –Ω—É–∂–µ–Ω

**–û—Ç–∫–∞—Ç**: ‚úÖ –ü—Ä–æ—Å—Ç–æ–π (git checkout –∏–ª–∏ —Ä—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)



