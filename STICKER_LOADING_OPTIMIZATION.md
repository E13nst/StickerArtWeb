# Оптимизация загрузки стикеров в галерее

## Проблема

Ранее логика загрузки стикеров не учитывала видимость карточек должным образом:
- Все дополнительные стикеры (2-й, 3-й) загружались с низким приоритетом `TIER_4_BACKGROUND`
- Для невидимых карточек все равно загружались дополнительные стикеры
- Слишком большой `rootMargin` (800px) приводил к загрузке стикеров для карточек, которые еще не видны
- При ротации следующий стикер загружался с минимальным приоритетом, что могло вызывать задержки

## Реализованные оптимизации

### 1. Приоритетная загрузка первого стикера для видимых карточек

**Изменения в `PackCard.tsx`:**
- Для **видимых карточек** (`isNear = true`):
  - Первые 6 паков: `TIER_1_FIRST_6_PACKS` (максимальный приоритет)
  - Остальные: `TIER_2_FIRST_IMAGE` (высокий приоритет)
- Для **невидимых карточек** (`isNear = false`):
  - Первые 6 паков: `TIER_2_FIRST_IMAGE` (средний приоритет)
  - Остальные: `TIER_3_ADDITIONAL` (низкий приоритет)

**Результат:** Видимые карточки получают максимальный приоритет загрузки первого стикера.

### 2. Высокоприоритетная загрузка стикеров для ротации

**Изменения в `PackCard.tsx`:**
- Для **видимых карточек** загружаются 2-й и 3-й стикеры с высоким приоритетом:
  - Первые 6 паков: `TIER_2_FIRST_IMAGE` (приоритет 3)
  - Остальные видимые: `TIER_3_ADDITIONAL` (приоритет 2)
- Для **невидимых карточек** дополнительные стикеры **не загружаются** вообще

**Результат:** 
- Стикеры для ротации в видимых карточках загружаются быстро
- Уменьшено количество запросов к стикер-процессору (не загружаем стикеры для невидимых карточек)

### 3. Оптимизация определения видимости

**Изменения в `PackCard.tsx`:**
- Уменьшен `rootMargin` с `800px` до `200px`
- Более точное определение видимости карточек
- Загрузка стикеров только для действительно видимых карточек

**Результат:** Меньше лишних запросов для карточек, которые еще не видны пользователю.

### 4. Приоритетная загрузка при ротации

**Изменения в `useStickerRotation.ts`:**
- Добавлен параметр `loadPriority` для управления приоритетом загрузки следующего стикера
- Для видимых карточек используется высокий приоритет (`TIER_2` или `TIER_3`)
- Для невидимых карточек используется низкий приоритет (`TIER_4`)

**Изменения в `PackCard.tsx`:**
- Передается приоритет в `useStickerRotation` в зависимости от видимости карточки

**Результат:** При ротации следующий стикер загружается с высоким приоритетом для видимых карточек, что обеспечивает плавную ротацию без задержек.

## Итоговая схема приоритетов

### Для видимых карточек (isNear = true)

| Стикер | Первые 6 паков | Остальные паки |
|--------|---------------|----------------|
| 1-й стикер | `TIER_1` (4) - максимальный | `TIER_2` (3) - высокий |
| 2-й стикер | `TIER_2` (3) - высокий | `TIER_3` (2) - средний |
| 3-й стикер | `TIER_2` (3) - высокий | `TIER_3` (2) - средний |
| При ротации | `TIER_2` (3) - высокий | `TIER_3` (2) - средний |

### Для невидимых карточек (isNear = false)

| Стикер | Первые 6 паков | Остальные паки |
|--------|---------------|----------------|
| 1-й стикер | `TIER_2` (3) - средний | `TIER_3` (2) - низкий |
| 2-й стикер | **Не загружается** | **Не загружается** |
| 3-й стикер | **Не загружается** | **Не загружается** |
| При ротации | `TIER_4` (1) - минимальный | `TIER_4` (1) - минимальный |

## Преимущества оптимизации

1. ✅ **Максимальный приоритет для видимых карточек** - первый стикер видимых карточек загружается с наивысшим приоритетом
2. ✅ **Быстрая ротация** - стикеры для ротации в видимых карточках загружаются с высоким приоритетом
3. ✅ **Меньше запросов** - не загружаем дополнительные стикеры для невидимых карточек
4. ✅ **Точное определение видимости** - уменьшен `rootMargin` для более точного определения видимых карточек
5. ✅ **Оптимизация очереди** - приоритетная обработка видимых карточек не блокируется фоновыми загрузками

## Ожидаемые результаты

- **Уменьшение количества запросов** к стикер-процессору на ~40-60% (не загружаем стикеры для невидимых карточек)
- **Быстрая загрузка видимых карточек** - первый стикер загружается с максимальным приоритетом
- **Плавная ротация** - стикеры для ротации загружаются заранее с высоким приоритетом
- **Лучшая производительность** - меньше конкуренции за слоты загрузки между видимыми и невидимыми карточками

