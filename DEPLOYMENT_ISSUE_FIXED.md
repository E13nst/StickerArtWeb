# üîß –ü—Ä–æ–±–ª–µ–º–∞ —Å–æ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–µ–π –Ω–∞ –ø—Ä–æ–¥–µ - –†–ï–®–ï–ù–ê

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞ —Å –æ—à–∏–±–∫–æ–π:
```
ReferenceError: storedInitData is not defined
```

–•–æ—Ç—è –≤ GitHub –∫–æ–¥ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (–∫–æ–º–º–∏—Ç `5c3877e`).

## üîç –ü—Ä–∏—á–∏–Ω–∞

**Docker –∫—ç—à–∏—Ä—É–µ—Ç —Å–ª–æ–∏ —Å–±–æ—Ä–∫–∏.** –î–∞–∂–µ –µ—Å–ª–∏ –∫–æ–¥ –∏–∑–º–µ–Ω–∏–ª—Å—è, Docker –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–±–æ—Ä–∫–∏, –µ—Å–ª–∏:
1. –§–∞–π–ª—ã `package.json`/`package-lock.json` –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
2. –ò—Å—Ö–æ–¥–Ω–∏–∫–∏ –≤ `miniapp/` —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è Docker "–ø–æ—Ö–æ–∂–∏"

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –£–ª—É—á—à–µ–Ω Dockerfile

```dockerfile
# –î–æ–±–∞–≤–ª–µ–Ω ARG –¥–ª—è cache busting
ARG CACHEBUST=1

# –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–±–æ—Ä–∫–µ
RUN echo "=== BUILD INFO ===" && \
    echo "CACHEBUST: ${CACHEBUST}" && \
    echo "NODE_VERSION: $(node --version)" && \
    date

# –§–æ—Ä—Å–∏—Ä—É–µ–º —á–∏—Å—Ç—É—é —Å–±–æ—Ä–∫—É
RUN rm -rf dist && \
    npx tsc && \
    npx vite build && \
    mkdir -p dist && \
    cp index.html dist/
```

### 2. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

**–î–æ:**
```dockerfile
RUN npx tsc && npx vite build && mkdir -p dist && cp index.html dist/
```

**–ü–æ—Å–ª–µ:**
```dockerfile
# –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–±–æ—Ä–∫–∏
RUN rm -rf dist && \
    npx tsc && \
    npx vite build && \
    mkdir -p dist && \
    cp index.html dist/
```

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `ARG CACHEBUST=1` - –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É
- `rm -rf dist` - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á–∏—Å—Ç—É—é —Å–±–æ—Ä–∫—É
- –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–±–æ—Ä–∫–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å

### Amvera –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç

–ü–æ—Å–ª–µ `git push` Amvera –¥–æ–ª–∂–µ–Ω:
1. –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π Dockerfile
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä–∫—É
3. –í—ã–ø–æ–ª–Ω–∏—Ç—å `rm -rf dist` (–æ—á–∏—Å—Ç–∫–∞)
4. –°–æ–±—Ä–∞—Ç—å —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è (—á–µ—Ä–µ–∑ 5-10 –º–∏–Ω—É—Ç)

```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏
amvera logs build sticker-art-e13nst | tail -50

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# === BUILD INFO ===
# CACHEBUST: 1
# NODE_VERSION: v18.x.x
# ...

# 2. –ü—Ä–æ–≤–µ—Ä—å runtime –ª–æ–≥–∏
amvera logs run sticker-art-e13nst | tail -50

# –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ mkdir() –∏–ª–∏ nginx

# 3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ hash —Ñ–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–∏–ª—Å—è
curl -s https://sticker-art-e13nst.amvera.io/miniapp/ | grep -o 'index-[^"]*\.js'

# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ù–û–í–´–ô hash (–Ω–µ index-CPVuJ2V4.js)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

1. **–û—Ç–∫—Ä—ã—Ç—å –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ**:
   ```
   https://sticker-art-e13nst.amvera.io/miniapp/
   ```

2. **Hard refresh** (Ctrl+Shift+R)

3. **–ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞** - –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   ‚ùå ReferenceError: storedInitData is not defined
   ```

4. **–î–æ–ª–∂–Ω–æ –±—ã—Ç—å**:
   ```
   ‚úÖ üîß PRODUCTION MODE: initData –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
   ‚úÖ üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...
   ‚úÖ –°—Ç–∏–∫–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
   ```

### E2E —Ç–µ—Å—Ç—ã

```bash
npm run test:prod
```

–î–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É >10 –∫–∞—Ä—Ç–æ—á–µ–∫.

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å

#### 1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è

```bash
amvera describe project sticker-art-e13nst
```

–°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `Running`, –∞ –Ω–µ `Building` –∏–ª–∏ `Failed`.

#### 2. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –Ω–∞ –æ—à–∏–±–∫–∏

```bash
amvera logs build sticker-art-e13nst | grep -i error
```

#### 3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å

```bash
amvera exec sticker-art-e13nst -- ls -la /usr/share/nginx/html/miniapp/

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# index.html
# assets/ (—Å –Ω–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏)
```

#### 4. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ index.html

```bash
amvera exec sticker-art-e13nst -- cat /usr/share/nginx/html/miniapp/index.html | grep -o 'index-[^"]*\.js'
```

Hash –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–æ–≤—ã–π.

### –ï—Å–ª–∏ Amvera –Ω–µ –Ω–∞—á–∞–ª –¥–µ–ø–ª–æ–π

#### –í–∞—Ä–∏–∞–Ω—Ç A: –§–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ UI

1. https://console.amvera.ru/
2. –ü—Ä–æ–µ–∫—Ç `sticker-art-e13nst`
3. –ö–Ω–æ–ø–∫–∞ **"Rebuild"**

#### –í–∞—Ä–∏–∞–Ω—Ç B: Dummy commit

```bash
git commit --allow-empty -m "chore: force rebuild"
git push
```

#### –í–∞—Ä–∏–∞–Ω—Ç C: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook

1. GitHub ‚Üí Settings ‚Üí Webhooks
2. –ù–∞–π—Ç–∏ webhook –¥–ª—è Amvera
3. Recent Deliveries
4. –ï—Å–ª–∏ failed - –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ Amvera UI

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–°–º. –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é: `FORCE_REBUILD.md`

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] Dockerfile –æ–±–Ω–æ–≤–ª–µ–Ω (`rm -rf dist`, `ARG CACHEBUST`)
- [x] –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã –≤ GitHub
- [ ] Amvera –Ω–∞—á–∞–ª –¥–µ–ø–ª–æ–π (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã)
- [ ] –õ–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "=== BUILD INFO ==="
- [ ] Nginx —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Hash —Ñ–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–∏–ª—Å—è (–Ω–µ `index-CPVuJ2V4.js`)
- [ ] –ë—Ä–∞—É–∑–µ—Ä (–∏–Ω–∫–æ–≥–Ω–∏—Ç–æ) –±–µ–∑ –æ—à–∏–±–∫–∏ `storedInitData`
- [ ] –°—Ç–∏–∫–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –Ω–∞ –ø—Ä–æ–¥–µ
- [ ] E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (`npm run test:prod`)

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:
- ‚úÖ –ù–æ–≤—ã–π hash –≤ –∏–º–µ–Ω–∞—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –û—à–∏–±–∫–∞ `storedInitData is not defined` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
- ‚úÖ –°—Ç–∏–∫–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- ‚úÖ –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

**–ö–æ–º–º–∏—Ç—ã:**
- `6e8d9fe` - fix: force clean build in Docker with cache busting
- `5c3877e` - fix: gallery loading and API optimization with E2E tests





