# –ö—ç—à –¥–ª—è —Å—Ç–∏–∫–µ—Ä–æ–≤ (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º /data –¥–ª—è persistent storage (–Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ)
# proxy_cache_path –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ http –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –Ω–µ –≤ server
proxy_cache_path /data/cache/nginx/stickers 
    levels=1:2 
    keys_zone=sticker_cache:64m 
    inactive=14d 
    max_size=5g 
    use_temp_path=off;

# –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—à–µ–Ω —Ñ–∞–π–ª —Å—Ç–∏–∫–µ—Ä–∞ (?file=true|1)
map $arg_file $stickers_cache_bypass {
    default 1;
    ""      1;
    0        1;
    false    1;
    true     0;
    1        0;
}

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞
log_format cache_stats '$time_local|$remote_addr|$request_method|$request_uri|'
                       'cache_status=$upstream_cache_status|'
                       'cache_key="$request_uri"|'
                       'status=$status|bytes=$body_bytes_sent';

server {
    listen 80;
    server_name _;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # –õ–æ–≥ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞
    access_log /var/log/nginx/cache_stats.log cache_stats;
    
    # Gzip compression (—É–ª—É—á—à–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
    gzip on;
    gzip_vary on;
    gzip_min_length 256;
    gzip_comp_level 6;
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∂–∞—Ç–∏–µ –¥–ª—è JSON (–∞–Ω–∏–º–∞—Ü–∏–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤) –∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json image/svg+xml;
    gzip_proxied any;
    gzip_disable "msie6";
    
    # Brotli compression (–µ—Å–ª–∏ –º–æ–¥—É–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω, –ª—É—á—à–µ —á–µ–º gzip)
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css text/xml text/javascript application/javascript application/json image/svg+xml;
    
    # –ü—Ä—è–º–æ–π –ø—Ä–æ–∫—Å–∏ –∫ sticker-processor (–Ω–æ–≤—ã–π –ø—É—Ç—å /stickers/)
    location ~ ^/stickers/[^/]+$ {
        proxy_pass ${STICKER_PROCESSOR_ORIGIN};

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_ssl_server_name on;
        
        # üî• –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü–µ—Ä–µ–¥–∞–µ–º Accept –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebP/AVIF
        # –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebP, –ø–µ—Ä–µ–¥–∞–µ–º —ç—Ç–æ –≤ sticker-processor
        # (sticker-processor –º–æ–∂–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å WebP –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        proxy_set_header Accept $http_accept;

        proxy_buffering on;
        proxy_buffer_size 64k;
        proxy_buffers 4 128k;
        proxy_busy_buffers_size 128k;

        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        proxy_cache sticker_cache;
        proxy_cache_methods GET HEAD;
        proxy_cache_min_uses 2;
        proxy_cache_valid 200 14d;
        proxy_cache_valid 404 1m;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        proxy_cache_bypass $http_upgrade;
        proxy_no_cache $stickers_cache_bypass;
        proxy_cache_bypass $stickers_cache_bypass;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_revalidate on;

        add_header X-Cache-Status $upstream_cache_status always;

        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Telegram-Init-Data, X-Telegram-Bot-Name" always;
        add_header Cache-Control "public, max-age=1209600" always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # API proxy –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤–∫–ª—é—á–∞—è /api/auth)
    location /api {
        proxy_pass ${BACKEND_URL};
        proxy_http_version 1.1;
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_ssl_server_name on;
        
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Telegram-Init-Data, X-Telegram-Bot-Name" always;
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # Telegram Mini App - —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ /miniapp/
    location = /miniapp/ {
        try_files /miniapp/index.html =404;
        add_header X-Frame-Options "ALLOW-FROM https://web.telegram.org" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
    
    # Telegram Mini App - –±–µ–∑ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–≥–æ —Å–ª—ç—à–∞ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /
    location = /miniapp {
        return 301 /miniapp/;
    }
    
    # Telegram Mini App - –≤—Å–µ —Ñ–∞–π–ª—ã –∏ SPA routing
    location /miniapp/ {
        try_files $uri /miniapp/index.html;
        add_header X-Frame-Options "ALLOW-FROM https://web.telegram.org" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
    
    # Favicon –æ–±—Ä–∞–±–æ—Ç–∫–∞
    location = /favicon.ico {
        try_files /favicon.ico =204;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        # üî• –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        add_header Vary "Accept-Encoding" always;
    }
    
    # Landing page - –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞
    location / {
        try_files $uri /index.html;
        add_header X-Frame-Options "ALLOW-FROM https://web.telegram.org" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
    
    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞ - –ø—Ä–æ—Å—Ç–∞—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    location = /cache-stats {
        default_type text/html;
        try_files /cache-stats.html =404;
        add_header Content-Type "text/html; charset=utf-8" always;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }
    
    # API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—ç—à–µ
    location = /api/cache-info {
        default_type application/json;
        access_log off;
        add_header Content-Type "application/json; charset=utf-8" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Cache-Control "no-cache" always;
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        # –û—Ç–¥–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π JSON —Ñ–∞–π–ª —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∫—ç—à–∞
        try_files /cache-info.json =404;
    }
}
