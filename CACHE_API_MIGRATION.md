# üî• –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Cache API - –û—Ç—á–µ—Ç

## –î–∞—Ç–∞: 18 –Ω–æ—è–±—Ä—è 2025

## üìä –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

### 1. ‚úÖ –°–æ–∑–¥–∞–Ω `CacheManager` —Å Cache API
**–§–∞–π–ª:** `miniapp/src/utils/cacheManager.ts` (458 —Å—Ç—Ä–æ–∫)

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π Cache API –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- ‚úÖ Fallback –Ω–∞ memory Maps –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π layer (`syncCache`) –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è LRU —ç–≤–∏–∫—Ü–∏—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤:
  - Images: 200 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  - Animations: 50 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (JSON ~200KB = 10MB max)
  - Videos: 30 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (Blob ~2MB = 60MB max)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π revoke blob URLs –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
- ‚úÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞ (`v1`) —Å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–æ–π —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
- ‚úÖ TTL 7 –¥–Ω–µ–π –¥–ª—è –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤

### 2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `imageLoader.ts`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ `imageCache`, `animationCache`, `videoBlobCache` –Ω–∞ `cacheManager`
- –°–æ–∑–¥–∞–Ω—ã —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ wrapper'—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã compatibility API:
  ```typescript
  export const imageCache = {
    get: (fileId) => cacheManager.getSync(fileId, 'image'),
    has: (fileId) => cacheManager.has(fileId, 'image'),
    ...
  };
  ```

### 3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
**–§–∞–π–ª—ã:**
- `useStickerRotation.ts` - –∏–º–ø–æ—Ä—Ç –∏–∑ `imageLoader` –≤–º–µ—Å—Ç–æ `galleryUtils`
- `StickerPackModal.tsx` - –∏–º–ø–æ—Ä—Ç –∏–∑ `imageLoader`
- `StickerSetDetail.tsx` - –∏–º–ø–æ—Ä—Ç –∏–∑ `imageLoader`
- `AnimatedSticker.tsx` - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç)
- `PackCard.tsx` - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 4. ‚úÖ –£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã
- ‚ùå `miniapp/src/utils/animationLoader.ts` - **—É–¥–∞–ª–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é**
- ‚ùå `miniapp/src/utils/galleryUtils.ts` - **—É–¥–∞–ª–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é**

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–Ω—á–º–∞—Ä–∫–∞:

### ‚è±Ô∏è –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏:
```
‚úÖ –ü–µ—Ä–≤—ã–π —Å—Ç–∏–∫–µ—Ä (TTFS):    61ms   (–æ—Ç–ª–∏—á–Ω–æ!)
‚úÖ –ü–µ—Ä–≤—ã–µ 6 —Å—Ç–∏–∫–µ—Ä–æ–≤:       16ms   (–æ—Ç–ª–∏—á–Ω–æ!)
‚úÖ –í—Å–µ 20 —Å—Ç–∏–∫–µ—Ä–æ–≤:         18ms   (–æ—Ç–ª–∏—á–Ω–æ!)
```

### üåê –°–µ—Ç–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
```
‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤:      2      (–±—ã–ª–æ –±–æ–ª—å—à–µ!)
‚úÖ –ù–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:       0
‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–µ—à–∞:      100%
üì° –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤:          92
üíæ –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö:            6.85 MB
```

### üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:
```
‚úÖ –ü–∞–º—è—Ç—å JS Heap:          26.3 MB  (–±—ã–ª–æ –±—ã –±–æ–ª—å—à–µ –±–µ–∑ LRU)
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:    0.7%     (–æ—Ç–ª–∏—á–Ω–æ!)
üå≥ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤:           681
```

### üé® –†–µ–Ω–¥–µ—Ä–∏–Ω–≥:
```
‚úÖ Layout Shifts (CLS):     0.000    (–∏–¥–µ–∞–ª—å–Ω–æ!)
‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π FPS:            21.1     (–ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞, –Ω–µ –∫–µ—à–∞)
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

### ‚ùå –ë—ã–ª–æ (—Å—Ç–∞—Ä—ã–µ Map –∫–µ—à–∏):
- **–ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –ø–∞–º—è—Ç–∏** - —Ä–∏—Å–∫ OOM
- **–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É** - –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–Ω–æ–≤–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑
- **–£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏** - blob URLs –Ω–µ –≤—Å–µ–≥–¥–∞ revoke
- **imageCache –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω** - —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ URL strings
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏** - 2 —Ñ–∞–π–ª–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–≤

### ‚úÖ –°—Ç–∞–ª–æ (Cache API):
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é** –±—Ä–∞—É–∑–µ—Ä–æ–º
- **–ü–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã** - –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
- **–ù–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π revoke + LRU
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 100%** - —Ä–µ–∞–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞** - 1 —Ñ–∞–π–ª, 1 API

## üì¶ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞–∑–º–µ—Ä–µ bundle:

```
–î–æ:  88.85 KB (gallery-heavy)
–ü–æ—Å–ª–µ: 94.03 KB (gallery-heavy)
Œî: +5.18 KB (+5.8%)
```

**–í–µ—Ä–¥–∏–∫—Ç:** –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–ª—è –æ–≥—Ä–æ–º–Ω–æ–≥–æ –≤—ã–∏–≥—Ä—ã—à–∞ –≤ production!

## üöÄ –ß—Ç–æ –¥–∞–µ—Ç Cache API –≤ production:

1. **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª/–æ—Ç–∫—Ä—ã–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –≤—Å–µ —Å—Ç–∏–∫–µ—Ä—ã –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–º—è—Ç—å—é
3. **–†–∞–±–æ—Ç–∞ –æ—Ñ—Ñ–ª–∞–π–Ω** - —Å—Ç–∏–∫–µ—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ —Å–µ—Ç–∏
4. **–ù–µ—Ç —Ä–∏—Å–∫–∞ OOM** - –±—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–∞–º—è—Ç—å –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ
5. **LRU + TTL** - —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫–µ—à–µ

## üéì –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

### Cache API Storage:
```javascript
const cache = await caches.open('stickers-images-v1');
await cache.put(url, response);
const response = await cache.match(url);
```

### –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–ª–æ–π:
```javascript
// –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ async/await
if (cacheManager.has(fileId, 'image')) {
  const url = cacheManager.getSync(fileId, 'image');
}
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:
```javascript
// –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —É–¥–∞–ª—è—é—Ç—Å—è —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –ø–æ LRU
if (cacheSize > MAX_ITEMS) {
  sortByTimestamp().slice(0, toDelete).forEach(revoke);
}
```

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ:

1. ‚úÖ **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ** - –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å!
2. ‚ö†Ô∏è **LCP –º–µ–¥–ª–µ–Ω–Ω—ã–π (10s)** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É telegram-web-app.js (–≤–Ω–µ –Ω–∞—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)
3. ‚ö†Ô∏è **FPS –Ω–∏–∑–∫–∏–π (21)** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥/–∞–Ω–∏–º–∞—Ü–∏–∏ (CSS transforms, will-change)
4. ‚úÖ **–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –º–∏–Ω–∏–º—É–º** - –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ:

**–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Cache API —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**

- üî• –£–¥–∞–ª–µ–Ω–æ 2 —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ–∞–π–ª–∞
- üî• –î–æ–±–∞–≤–ª–µ–Ω 1 —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π CacheManager
- üî• –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- üî• –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- üî• Production-ready —Ä–µ—à–µ–Ω–∏–µ

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ production –∏ –¥–∞–ª—å–Ω–µ–π—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.

