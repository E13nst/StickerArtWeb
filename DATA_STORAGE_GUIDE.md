# üì¶ Amvera /data Persistent Storage Guide

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ —Ñ–∞–π–ª—ã –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ **—ç—Ñ–µ–º–µ—Ä–Ω—ã–µ** - –æ–Ω–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ/–ø–µ—Ä–µ—Å–±–æ—Ä–∫–µ –æ–±—Ä–∞–∑–∞.

–î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–∫—ç—à, SQLite –ë–î, —Ñ–∞–π–ª—ã) –Ω–∞ Amvera –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è **`/data`**.

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. Nginx –∫—ç—à –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ `/data`

**–î–æ:**
```nginx
proxy_cache_path /var/cache/nginx/stickers  # ‚ùå –û—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ
```

**–ü–æ—Å–ª–µ:**
```nginx
proxy_cache_path /data/cache/nginx/stickers  # ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏
```

### 2. Init-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `/data`

–°–æ–∑–¥–∞–Ω `docker-entrypoint.sh`, –∫–æ—Ç–æ—Ä—ã–π:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å `/data`
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∫—ç—à–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞ (—Ä–∞–∑–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤)
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 3. Dockerfile –∏–∑–º–µ–Ω–µ–Ω–∏—è

```dockerfile
# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∫—ç—à–∞
RUN mkdir -p /data/cache/nginx/stickers && \
    chown -R nginx:nginx /data/cache

# –ö–æ–ø–∏—Ä—É–µ–º init-—Å–∫—Ä–∏–ø—Ç
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# –ò—Å–ø–æ–ª—å–∑—É–µ–º init-—Å–∫—Ä–∏–ø—Ç –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ nginx
ENTRYPOINT ["/docker-entrypoint.sh"]
```

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `/data` —á–µ—Ä–µ–∑ Amvera UI

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

1. **–ó–∞–π–¥–∏—Ç–µ –≤ Amvera Dashboard:**
   - https://console.amvera.ru/

2. **–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç:**
   - `StickerArtWeb` –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

3. **–û—Ç–∫—Ä–æ–π—Ç–µ –ª–æ–≥–∏ (Logs):**
   - –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç ‚Üí –≤–∫–ª–∞–¥–∫–∞ "–õ–æ–≥–∏"

4. **–ù–∞–π–¥–∏—Ç–µ –ª–æ–≥–∏ init-—Å–∫—Ä–∏–ø—Ç–∞:**
   ```
   === AMVERA /data STORAGE CHECK ===
   ‚úÖ /data directory exists
   
   === CHECKING NGINX CACHE STATS ===
   Cache size: 1.5G
   Cached files: 342
   ```

5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞:**
   - –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π: `Cache size: 0`, `Cached files: 0`
   - –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤: `Cache size: XXX MB`, `Cached files: XXX`
   - –ü–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è: **–∫—ç—à –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è!**

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Amvera CLI

```bash
# –õ–æ–≥–∏ –±–∏–ª–¥–∞
amvera logs build stickerartgallery

# –õ–æ–≥–∏ —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (runtime)
amvera logs run stickerartgallery

# –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫ –ø—Ä–æ /data
amvera logs run stickerartgallery | grep "/data"
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫—ç—à–∞

### 1. –ü–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç (–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∏–∫–µ—Ä—ã)

**DevTools ‚Üí Network:**
```
GET /api/proxy/stickers/xxx
Status: 200
X-Cache-Status: MISS          ‚Üê –ù–µ—Ç –≤ –∫—ç—à–µ, –∑–∞–≥—Ä—É–∑–∫–∞ —Å –±—ç–∫–µ–Ω–¥–∞
Time: 500ms
```

**–õ–æ–≥–∏ Nginx:**
```
Cache size: 0
Cached files: 0
```

### 2. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–∏–∑–∏—Ç (–∫—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç)

**DevTools ‚Üí Network:**
```
GET /api/proxy/stickers/xxx
Status: 200
X-Cache-Status: HIT           ‚Üê –ò–∑ –∫—ç—à–∞!
Time: 10ms                    ‚Üê 50x –±—ã—Å—Ç—Ä–µ–µ!
```

**–õ–æ–≥–∏ Nginx:**
```
Cache size: 156M
Cached files: 89
```

### 3. –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è/–ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ (–∫—ç—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è!)

**–õ–æ–≥–∏ init-—Å–∫—Ä–∏–ø—Ç–∞:**
```
=== CHECKING NGINX CACHE STATS ===
Cache size: 156M              ‚Üê –ö—ç—à –Ω–µ –æ—á–∏—Å—Ç–∏–ª—Å—è!
Cached files: 89
```

**DevTools ‚Üí Network:**
```
GET /api/proxy/stickers/xxx
Status: 200
X-Cache-Status: HIT           ‚Üê –í—Å–µ –µ—â–µ –∏–∑ –∫—ç—à–∞!
Time: 10ms
```

---

## üéØ –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ `/data`

### ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
- **Nginx –∫—ç—à** - –Ω–∞—à —Å–ª—É—á–∞–π
- **SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** - `/data/database.db`
- **–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã** - `/data/uploads/`
- **–õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** - `/data/logs/`
- **–°–µ—Å—Å–∏–∏** - `/data/sessions/`

### ‚ùå –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/tmp`)
- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã (–æ—Å—Ç–∞—é—Ç—Å—è –≤ –æ–±—Ä–∞–∑–µ)
- –°–µ–∫—Ä–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)

---

## üõ†Ô∏è Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: `/data` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ª–æ–≥–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Amvera - `/data` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∏–∫–µ—Ç –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É Amvera
3. –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/tmp` (–Ω–æ –∫—ç—à –±—É–¥–µ—Ç –æ—á–∏—â–∞—Ç—å—Å—è)

### –ü—Ä–æ–±–ª–µ–º–∞: –ö—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –õ–æ–≥–∏ init-—Å–∫—Ä–∏–ø—Ç–∞ - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É—Ç—å `/data/cache/nginx/stickers`
2. –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `chown -R nginx:nginx /data/cache`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `nginx -t` - –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Ñ–∏–≥–µ

### –ü—Ä–æ–±–ª–µ–º–∞: Permission denied –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ `/data`

**–†–µ—à–µ–Ω–∏–µ:**
```dockerfile
# –í Dockerfile —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∞–≤–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
RUN mkdir -p /data/cache/nginx/stickers && \
    chown -R nginx:nginx /data/cache && \
    chmod -R 755 /data/cache
```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `/data`

### –í –ª–æ–≥–∞—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```bash
# –†–∞–∑–º–µ—Ä –∫—ç—à–∞
du -sh /data/cache/nginx/stickers

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
find /data/cache/nginx/stickers -type f | wc -l

# –¢–æ–ø-10 —Å–∞–º—ã—Ö –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
find /data/cache/nginx/stickers -type f -exec ls -lh {} \; | sort -k5 -hr | head -10
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ nginx.conf:

```nginx
proxy_cache_path /data/cache/nginx/stickers 
    max_size=20g      # –ú–∞–∫—Å–∏–º—É–º 20GB
    inactive=30d      # –£–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
```

---

## üöÄ –î–µ–ø–ª–æ–π –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞

### 1. –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```bash
git add Dockerfile docker-entrypoint.sh nginx.conf
git commit -m "feat: use /data persistent storage for nginx cache"
git push origin main
```

### 2. –î–µ–ø–ª–æ–π –Ω–∞ Amvera:

Amvera –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç —Å–±–æ—Ä–∫—É –∏ –¥–µ–ø–ª–æ–π.

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:

```bash
# –ß–µ—Ä–µ–∑ CLI
amvera logs run stickerartgallery --follow

# –ò–ª–∏ –≤ UI
https://console.amvera.ru/ ‚Üí –≤–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí –õ–æ–≥–∏
```

### 4. –ù–∞–π–¥–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:

```
=== AMVERA /data STORAGE CHECK ===
‚úÖ /data directory exists
```

### 5. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç–∏–∫–µ—Ä–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

### 6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–Ω–æ–≤–∞ (—Ä–µ—Å—Ç–∞—Ä—Ç):

```bash
amvera restart stickerartgallery
amvera logs run stickerartgallery --follow
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
Cache size: 156M
Cached files: 89
```

**–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –ù–ï –Ω–æ–ª—å - –∑–Ω–∞—á–∏—Ç `/data` —Ä–∞–±–æ—Ç–∞–µ—Ç!** üéâ

---

## üìù –†–µ–∑—é–º–µ

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –ü—É—Ç—å –∫ –∫—ç—à—É | `/data/cache/nginx/stickers` |
| –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä | 20GB |
| –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ | 30 –¥–Ω–µ–π |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ |
| Persistence | ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏ |

–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é! üöÄ

