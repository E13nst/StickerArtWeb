<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Worker Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .status {
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      font-weight: 500;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #logs {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-entry {
      margin: 5px 0;
    }
    .log-info { color: #0ff; }
    .log-success { color: #0f0; }
    .log-error { color: #f00; }
    .log-warning { color: #ff0; }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-section h3 {
      margin-top: 0;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Service Worker Timeout Test</h1>
    
    <div id="sw-status" class="status info">
      –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Service Worker...
    </div>

    <div class="test-section">
      <h3>1Ô∏è‚É£ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker</h3>
      <button id="register-sw">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å SW</button>
      <button id="unregister-sw">–£–¥–∞–ª–∏—Ç—å SW</button>
      <button id="update-sw">–û–±–Ω–æ–≤–∏—Ç—å SW</button>
    </div>

    <div class="test-section">
      <h3>2Ô∏è‚É£ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞ (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)</h3>
      <p>–ó–∞–≥—Ä—É–∑–∏–º —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–∏–∫–µ—Ä —á–µ—Ä–µ–∑ Service Worker —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π —Ç–∞–π–º–∞—É—Ç–æ–≤.</p>
      <button id="test-sticker">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä</button>
      <button id="test-timeout">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–π–º–∞—É—Ç (–º–µ–¥–ª–µ–Ω–Ω—ã–π URL)</button>
      
      <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <label for="file-id-input" style="display: block; margin-bottom: 8px; font-weight: 600;">
          –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Å—Ç–∏–∫–µ—Ä –ø–æ file_id:
        </label>
        <input 
          type="text" 
          id="file-id-input" 
          placeholder="CAACAgIAAxUAAWkVkq0qBllGCTsC8hZrZvorEpT_AAIBeQAC0uhoSrXyOR-sWh8wNgQ"
          style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 13px; box-sizing: border-box;"
        />
        <div style="margin-top: 10px;">
          <button id="load-custom-sticker" style="background: #28a745;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∏–∫–µ—Ä</button>
          <button id="clear-file-id" style="background: #6c757d;">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div style="margin-top: 8px; font-size: 12px; color: #666;">
          üí° –ü—Ä–∏–º–µ—Ä—ã file_id –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å—Ç–∏–∫–µ—Ä—Å–µ—Ç–∞ –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ
        </div>
      </div>
      
      <div id="sticker-result" style="margin-top: 15px;"></div>
    </div>

    <div class="test-section">
      <h3>3Ô∏è‚É£ –¢–µ—Å—Ç retry –ª–æ–≥–∏–∫–∏</h3>
      <p>–ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ SW –¥–µ–ª–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö 504/503.</p>
      <button id="test-retry">–¢–µ—Å—Ç Retry (3 –ø–æ–ø—ã—Ç–∫–∏)</button>
    </div>

    <div class="test-section">
      <h3>4Ô∏è‚É£ –ö–µ—à</h3>
      <button id="check-cache">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à</button>
      <button id="clear-cache">–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à</button>
    </div>

    <div id="logs">
      <div class="log-entry log-info">–õ–æ–≥–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...</div>
    </div>
  </div>

  <script>
    const logs = document.getElementById('logs');
    const statusDiv = document.getElementById('sw-status');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logs.appendChild(entry);
      logs.scrollTop = logs.scrollHeight;
    }

    function updateStatus(message, type = 'info') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ SW –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function checkSWStatus() {
      if ('serviceWorker' in navigator) {
        const registration = await navigator.serviceWorker.getRegistration('/miniapp/');
        if (registration) {
          if (registration.active) {
            updateStatus('‚úÖ Service Worker –∞–∫—Ç–∏–≤–µ–Ω', 'success');
            log('‚úÖ Service Worker –∞–∫—Ç–∏–≤–µ–Ω', 'success');
            log('   Script: ' + registration.active.scriptURL, 'info');
            log('   Scope: ' + registration.scope, 'info');
            log('   State: ' + registration.active.state, 'info');
          } else if (registration.installing) {
            updateStatus('‚è≥ Service Worker —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...', 'info');
            log('Service Worker —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...', 'info');
          } else if (registration.waiting) {
            updateStatus('‚è≥ Service Worker –æ–∂–∏–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏...', 'info');
            log('Service Worker –æ–∂–∏–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (–æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É)', 'warning');
          }
        } else {
          updateStatus('‚ùå Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'error');
          log('Service Worker –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
          log('–ù–∞–∂–º–∏—Ç–µ "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å SW" –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏', 'info');
        }
      } else {
        updateStatus('‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
        log('Service Worker API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
      }
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW
    document.getElementById('register-sw').addEventListener('click', async () => {
      log('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker...', 'info');
      try {
        // –§–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ /miniapp/sw.js, scope –º–æ–∂–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Å–∞–π—Ç
        const registration = await navigator.serviceWorker.register('/miniapp/sw.js', {
          scope: '/miniapp/'
        });
        log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'success');
        log('   Scope: ' + registration.scope, 'info');
        log('   URL: ' + registration.active?.scriptURL, 'info');
        updateStatus('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'success');
        
        // –ñ–¥–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        registration.addEventListener('updatefound', () => {
          log('–ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SW...', 'info');
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            log(`SW —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${newWorker.state}`, 'info');
            if (newWorker.state === 'activated') {
              log('‚úÖ SW –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'success');
              checkSWStatus();
            }
          });
        });
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
        log(`   Stack: ${error.stack}`, 'error');
        updateStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞
        try {
          const testFetch = await fetch('/miniapp/sw.js');
          if (testFetch.ok) {
            log('  ‚úÖ –§–∞–π–ª sw.js –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ URL', 'success');
          } else {
            log(`  ‚ùå –§–∞–π–ª sw.js –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å: ${testFetch.status}`, 'error');
          }
        } catch (fetchError) {
          log(`  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å sw.js: ${fetchError.message}`, 'error');
        }
      }
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ SW
    document.getElementById('unregister-sw').addEventListener('click', async () => {
      log('–£–¥–∞–ª–µ–Ω–∏–µ Service Worker...', 'warning');
      const registration = await navigator.serviceWorker.getRegistration('/miniapp/');
      if (registration) {
        await registration.unregister();
        log('‚úÖ Service Worker —É–¥–∞–ª–µ–Ω', 'success');
        updateStatus('Service Worker —É–¥–∞–ª–µ–Ω', 'info');
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É
        setTimeout(() => {
          log('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...', 'info');
          window.location.reload();
        }, 1000);
      } else {
        log('Service Worker –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
      }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SW
    document.getElementById('update-sw').addEventListener('click', async () => {
      log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker...', 'info');
      const registration = await navigator.serviceWorker.getRegistration('/miniapp/');
      if (registration) {
        await registration.update();
        log('‚úÖ –ó–∞–ø—Ä–æ—à–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SW', 'success');
        log('–ï—Å–ª–∏ –µ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –æ–Ω–∏ —É—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', 'info');
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => checkSWStatus(), 2000);
      } else {
        log('‚ùå Service Worker –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
      }
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞ –ø–æ file_id
    async function loadSticker(fileId) {
      log(`üñºÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞: ${fileId}`, 'info');
      const stickerUrl = `https://sticker-art-e13nst.amvera.io/stickers/${fileId}?file=true`;
      
      const startTime = Date.now();
      try {
        const response = await fetch(stickerUrl);
        const elapsed = Date.now() - startTime;
        
        if (response.ok) {
          const blob = await response.blob();
          const sizeKB = (blob.size / 1024).toFixed(2);
          log(`‚úÖ –°—Ç–∏–∫–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –∑–∞ ${elapsed}ms (—Ä–∞–∑–º–µ—Ä: ${sizeKB} KB)`, 'success');
          log(`üìä –°—Ç–∞—Ç—É—Å: ${response.status}, Cache: ${response.headers.get('X-Cache-Status') || 'N/A'}`, 'info');
          log(`üì¶ Content-Type: ${response.headers.get('Content-Type')}`, 'info');
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
          const url = URL.createObjectURL(blob);
          const contentType = response.headers.get('Content-Type') || '';
          
          let mediaHtml = '';
          if (contentType.includes('video')) {
            mediaHtml = `<video src="${url}" autoplay loop muted style="max-width: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></video>`;
          } else if (contentType.includes('json') || contentType.includes('tgs')) {
            mediaHtml = `<div style="padding: 20px; background: #fff3cd; border-radius: 8px; color: #856404;">
              üìÑ TGS (Lottie) –∞–Ω–∏–º–∞—Ü–∏—è - —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è<br>
              –†–∞–∑–º–µ—Ä: ${sizeKB} KB
            </div>`;
          } else {
            mediaHtml = `<img src="${url}" style="max-width: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">`;
          }
          
          document.getElementById('sticker-result').innerHTML = `
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <div style="margin-bottom: 10px; font-weight: 600;">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
              ${mediaHtml}
              <div style="margin-top: 10px; font-size: 13px; color: #666;">
                <strong>File ID:</strong> ${fileId}<br>
                <strong>–†–∞–∑–º–µ—Ä:</strong> ${sizeKB} KB<br>
                <strong>–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏:</strong> ${elapsed}ms<br>
                <strong>–ö–µ—à:</strong> ${response.headers.get('X-Cache-Status') || 'N/A'}
              </div>
            </div>
          `;
        } else {
          log(`‚ùå –û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`, 'error');
          document.getElementById('sticker-result').innerHTML = `
            <div style="padding: 15px; background: #f8d7da; border-radius: 8px; color: #721c24;">
              ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∏–∫–µ—Ä<br>
              –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}
            </div>
          `;
        }
      } catch (error) {
        const elapsed = Date.now() - startTime;
        log(`‚ùå –¢–∞–π–º–∞—É—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ—Å–ª–µ ${elapsed}ms: ${error.message}`, 'error');
        document.getElementById('sticker-result').innerHTML = `
          <div style="padding: 15px; background: #f8d7da; border-radius: 8px; color: #721c24;">
            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}<br>
            –í—Ä–µ–º—è –¥–æ –æ—à–∏–±–∫–∏: ${elapsed}ms
          </div>
        `;
      }
    }

    // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞
    document.getElementById('test-sticker').addEventListener('click', async () => {
      const testFileId = 'CAACAgIAAxUAAWkVkq0qBllGCTsC8hZrZvorEpT_AAIBeQAC0uhoSrXyOR-sWh8wNgQ';
      await loadSticker(testFileId);
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Å—Ç–∏–∫–µ—Ä–∞
    document.getElementById('load-custom-sticker').addEventListener('click', async () => {
      const input = document.getElementById('file-id-input');
      const fileId = input.value.trim();
      
      if (!fileId) {
        log('‚ùå –í–≤–µ–¥–∏—Ç–µ file_id —Å—Ç–∏–∫–µ—Ä–∞', 'error');
        return;
      }
      
      await loadSticker(fileId);
    });

    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è file_id
    document.getElementById('clear-file-id').addEventListener('click', () => {
      document.getElementById('file-id-input').value = '';
      document.getElementById('sticker-result').innerHTML = '';
      log('üóëÔ∏è –ü–æ–ª–µ file_id –æ—á–∏—â–µ–Ω–æ', 'info');
    });

    // Enter –≤ –ø–æ–ª–µ file_id —Ç–æ–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∏–∫–µ—Ä
    document.getElementById('file-id-input').addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('load-custom-sticker').click();
      }
    });

    // –¢–µ—Å—Ç —Ç–∞–π–º–∞—É—Ç–∞ (–º–µ–¥–ª–µ–Ω–Ω—ã–π URL)
    document.getElementById('test-timeout').addEventListener('click', async () => {
      log('‚è±Ô∏è –¢–µ—Å—Ç —Ç–∞–π–º–∞—É—Ç–∞ (–±—É–¥–µ—Ç –∂–¥–∞—Ç—å 20 —Å–µ–∫—É–Ω–¥)...', 'warning');
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º httpbin.org/delay/20 –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
      const slowUrl = 'https://httpbin.org/delay/20';
      
      const startTime = Date.now();
      try {
        const response = await fetch(slowUrl);
        const elapsed = Date.now() - startTime;
        log(`–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∑–∞ ${elapsed}ms`, 'info');
      } catch (error) {
        const elapsed = Date.now() - startTime;
        log(`‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –ø–æ—Å–ª–µ ${elapsed}ms: ${error.message}`, 'warning');
        log('‚úÖ –≠—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ - SW –¥–æ–ª–∂–µ–Ω –ø—Ä–µ—Ä–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥', 'success');
      }
    });

    // –¢–µ—Å—Ç retry –ª–æ–≥–∏–∫–∏
    document.getElementById('test-retry').addEventListener('click', async () => {
      log('üîÑ –¢–µ—Å—Ç retry –ª–æ–≥–∏–∫–∏...', 'info');
      log('–û—Ç–∫—Ä–æ–π—Ç–µ DevTools Console –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ø—ã—Ç–æ–∫ retry', 'info');
      
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∏–∫–µ—Ä –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º
      const testUrl = 'https://sticker-art-e13nst.amvera.io/stickers/TEST_SLOW_STICKER?file=true';
      
      const startTime = Date.now();
      try {
        const response = await fetch(testUrl);
        const elapsed = Date.now() - startTime;
        log(`–û—Ç–≤–µ—Ç: ${response.status} –∑–∞ ${elapsed}ms`, 'info');
      } catch (error) {
        const elapsed = Date.now() - startTime;
        log(`–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å –æ—à–∏–±–∫–æ–π –∑–∞ ${elapsed}ms`, 'warning');
      }
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
    document.getElementById('check-cache').addEventListener('click', async () => {
      log('üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞...', 'info');
      const cacheNames = await caches.keys();
      log(`–ù–∞–π–¥–µ–Ω–æ –∫–µ—à–µ–π: ${cacheNames.length}`, 'info');
      
      for (const name of cacheNames) {
        const cache = await caches.open(name);
        const keys = await cache.keys();
        log(`  - ${name}: ${keys.length} –∑–∞–ø–∏—Å–µ–π`, 'info');
      }
    });

    // –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
    document.getElementById('clear-cache').addEventListener('click', async () => {
      log('üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–µ—à–µ–π...', 'warning');
      const cacheNames = await caches.keys();
      for (const name of cacheNames) {
        await caches.delete(name);
        log(`  ‚úÖ –£–¥–∞–ª–µ–Ω: ${name}`, 'success');
      }
      log('‚úÖ –í—Å–µ –∫–µ—à–∏ –æ—á–∏—â–µ–Ω—ã', 'success');
    });

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç SW
    navigator.serviceWorker.addEventListener('message', (event) => {
      log(`üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç SW: ${JSON.stringify(event.data)}`, 'info');
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    checkSWStatus();

    // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ fetch –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Performance API
    const observer = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (entry.entryType === 'resource' && entry.name.includes('stickers')) {
          log(`üìä Performance: ${entry.name.substring(entry.name.length - 50)} - ${entry.duration.toFixed(0)}ms`, 'info');
        }
      }
    });
    observer.observe({ entryTypes: ['resource'] });
  </script>
</body>
</html>

